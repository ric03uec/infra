- hosts: devbox
  become: true
  tasks:
    - name: include variables for devbox instances
      include_vars:
        file: devbox.yml
        name: devbox

    - name: apt update
      apt: update_cache=yes

    - name: install python on Ubuntu 16.04 host
      apt:
        name: python-minimal
        state: present

    - name: install zsh
      apt:
        name: zsh
        state: present

    - name: update hostname
      hostname:
        name: "{{ devbox.hostname }}"

    - name: update hostname in /etc/hosts
      lineinfile:
        dest: /etc/hosts
        regexp: '^127\.0\.0\.1[ \t]+localhost'
        line: '127.0.0.1 localhost {{ devbox.hostname }}'
        state: present

    - name: disable ssh with password on the host
      lineinfile:
        dest: /etc/ssh/ssh_config
        regexp: '#   PasswordAuthentication yes'
        line: '    PasswordAuthentication no'
        state: present

    - name: create group {{ devbox.username }}
      group:
        name: "{{ devbox.username }}"
        gid: 1002
        state: present

    - name: create user {{ devbox.username }}
      user:
        name: "{{ devbox.username }}"
        uid: 1002
        state: present
        append: yes
        group: "{{ devbox.username }}"
        groups: sudo
        create_home: yes
        shell: /bin/zsh
        generate_ssh_key: yes
        ssh_key_file: ".ssh/id_rsa_{{ devbox.username }}"

- hosts: devbox
  become: true
  tasks:
    - name: include variables for devbox instances
      include_vars:
        file: devbox.yml
        name: devbox

    - name: install random number generator management tools
      apt:
        name: rng-tools
        state: present

    - name: install tmux
      apt:
        name: tmux
        state: present

    - name: install htop
      apt:
        name: htop
        state: present

    - name: install git
      apt:
        name: git-core
        state: present

    - name: install git-extras
      apt:
        name: git-extras
        state: present

- hosts: devbox
  tasks:
    - name: include variables for devbox instances
      include_vars:
        file: devbox.yml
        name: devbox

    - name: Cloning oh-my-zsh
      git:
        repo: https://github.com/robbyrussell/oh-my-zsh
        dest: /home/{{ devbox.username }}/.oh-my-zsh

    - name: Create new ~/.zshrc from template
      vars:
        username: "{{ devbox.username }}"
      template:
        src: templates/zshrc.template.j2
        dest: /home/{{ devbox.username }}/.zshrc

    - name: update home folder ownership
      file:
        dest: /home/{{ devbox.username }}
        owner: "{{ devbox.username }}"
        group: "{{ devbox.username }}"
        recurse: yes
